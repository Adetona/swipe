{"absId":"rave@0.4.3/lib/crawl/npm","pluginId":"curl/loader/cjsm11","resourceId":"rave@0.4.3/lib/crawl/npm","loader":true,"source":"define('rave@0.4.3/lib/crawl/npm',['require','exports','module'],function(require,exports,module,define){/** @license MIT License (c) copyright 2014 original authors */\n/** @author Brian Cavalier */\n/** @author John Hann */\n\nvar join = require('../path').joinPaths;\nvar common = require('./common');\n\n// main exports\n\nexports.crawl = npmCrawl;\n\n// exports for testing\n\nexports.npmLoad = npmLoad;\nexports.npmContext = npmContext;\nexports.npmSetState = npmSetState;\nexports.npmChildCrawler = npmChildCrawler;\nexports.npmDependencies = npmDependencies;\n\nvar crawl = common.crawl;\nvar load = common.load;\n\nfunction npmCrawl (convert, rootUrl) {\n\tvar crawler = {\n\t\tload: npmLoad,\n\t\tgetChildrenNames: npmDependencies,\n\t\tconvert: convert\n\t};\n\tvar context = npmContext(crawler, rootUrl, '');\n\n\tcontext.childCrawler = npmChildCrawler;\n\tcontext.all = [];\n\n\treturn crawl(context)\n\t\t.then(function (root) {\n\t\t\treturn {\n\t\t\t\troot: root,\n\t\t\t\tall: context.all\n\t\t\t}\n\t\t});\n}\n\nfunction npmContext (base, rootUrl, name) {\n\tvar ctx = Object.create(base);\n\tctx.parent = base;\n\tctx.overrides = Object.create(base.overrides || null);\n\tctx.missing = Object.create(base.missing || null);\n\treturn npmSetState(ctx, rootUrl, name);\n}\n\nfunction npmSetState (ctx, rootUrl, name) {\n\tvar fileType = 'package.json';\n\tctx.name = name;\n\tctx.pmType = 'npm';\n\tctx.fileType = fileType;\n\tctx.fileUrl = join(rootUrl, fileType);\n\tctx.depFolder = join(rootUrl, 'node_modules');\n\tctx.rootUrl = rootUrl;\n\treturn ctx;\n}\n\nfunction npmChildCrawler (context, name) {\n\tvar childRoot = join(context.depFolder, name);\n\tvar childCtx = npmContext(context, childRoot, name);\n\treturn crawl(childCtx);\n\n}\n\nfunction npmDependencies (context, data) {\n\treturn Object.keys(data.metadata.dependencies || {})\n\t\t.concat(Object.keys(data.metadata.peerDependencies || {}));\n}\n\nfunction npmLoad (context, fileUrl) {\n\treturn load(context, fileUrl)\n\t\t['catch'](function (ex) {\n\t\t\treturn npmTraverseUp(context, fileUrl);\n\t\t});\n}\n\nfunction npmTraverseUp (context, fileUrl) {\n\tvar grandParent, grandRoot;\n\t// /client/node_modules/foo/node_modules/bar/package.json\n\t// /client/node_modules/bar/package.json\n\n\tif (!context.origFileUrl) context.origFileUrl = fileUrl;\n\n\tgrandParent = context.parent && context.parent.parent;\n\tif (!grandParent || !grandParent.depFolder) {\n\t\tthrow new Error('Did not find ' + context.origFileUrl);\n\t}\n\n\tgrandRoot = join(grandParent.depFolder, context.name);\n\tnpmSetState(context, grandRoot, context.name);\n\n\treturn npmLoad(context, context.fileUrl);\n}\n\n});\n\n","modules":[{"pos":0,"count":104,"id":"rave@0.4.3/lib/crawl/npm","depList":["require","exports","module"],"factory":true,"argList":["require","exports","module","define"],"requires":[{"id":"rave@0.4.3/lib/path","pos":236,"count":18},{"id":"rave@0.4.3/lib/crawl/common","pos":279,"count":19}]}],"compileTime":"2014-11-17T20:58:47.332Z"}